<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>í”Œë¡œìš°ì°¨íŠ¸ ë¹Œë”</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=Nanum+Gothic:wght@400;700&family=Nanum+Myeongjo:wght@400;700&family=Black+Han+Sans&family=Do+Hyeon&family=Jua&display=swap"/>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{overflow:hidden;font-family:'Noto Sans KR',sans-serif}
::-webkit-scrollbar{width:8px;height:8px}
::-webkit-scrollbar-track{background:transparent}
.dark-scroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:4px}
.light-scroll::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.15);border-radius:4px}
.tb-btn{display:flex;align-items:center;justify-content:center;width:32px;height:32px;border:1px solid transparent;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;transition:all .15s;background:transparent;color:inherit;position:relative}
.tb-btn:hover{border-color:rgba(255,255,255,0.15);background:rgba(255,255,255,0.06)}
.tb-btn.active{background:rgba(59,130,246,0.2);border-color:rgba(59,130,246,0.4);color:#60A5FA}
.tb-sep{width:1px;height:22px;background:rgba(255,255,255,0.1);margin:0 4px;flex-shrink:0}
.tb-select{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:6px;color:inherit;font-size:12px;padding:4px 6px;height:32px;cursor:pointer;outline:none;font-family:inherit}
.tb-select option{background:#1E293B;color:#E2E8F0}
.color-swatch{width:18px;height:18px;border-radius:4px;cursor:pointer;border:2px solid transparent;transition:all .12s}
.color-swatch:hover{transform:scale(1.15)}
.color-swatch.active{border-color:#fff;box-shadow:0 0 0 1px rgba(0,0,0,0.3)}
.toolbar-dark{background:#1E293B;border-bottom:1px solid rgba(255,255,255,0.08);color:#CBD5E1}
.toolbar-light{background:#fff;border-bottom:1px solid rgba(0,0,0,0.1);color:#334155}
.toolbar-light .tb-btn:hover{border-color:rgba(0,0,0,0.15);background:rgba(0,0,0,0.04)}
.toolbar-light .tb-btn.active{background:rgba(59,130,246,0.12);border-color:rgba(59,130,246,0.3);color:#2563EB}
.toolbar-light .tb-sep{background:rgba(0,0,0,0.1)}
.toolbar-light .tb-select{background:rgba(0,0,0,0.04);border-color:rgba(0,0,0,0.12);color:#334155}
.toolbar-light .tb-select option{background:#fff;color:#334155}
.color-popup{position:absolute;top:38px;left:50%;transform:translateX(-50%);padding:8px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.4);z-index:100;display:flex;flex-wrap:wrap;gap:4px;width:152px}
.color-popup-dark{background:#0F172A;border:1px solid rgba(255,255,255,0.1)}
.color-popup-light{background:#fff;border:1px solid rgba(0,0,0,0.1)}
.export-menu{position:absolute;top:38px;right:0;padding:6px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.4);z-index:100;display:flex;flex-direction:column;gap:2px;min-width:160px}
.export-menu-dark{background:#0F172A;border:1px solid rgba(255,255,255,0.1)}
.export-menu-light{background:#fff;border:1px solid rgba(0,0,0,0.1)}
.export-item{padding:8px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:500;border:none;background:transparent;text-align:left;width:100%;display:flex;align-items:center;gap:8px;transition:background .12s}
.zoom-badge{position:absolute;bottom:16px;left:16px;padding:6px 14px;border-radius:8px;font-size:12px;font-weight:600;pointer-events:none;user-select:none;transition:opacity .3s}
</style>
</head>
<body>
<div id="root"></div>
<script>
function loadScript(src) {
  return new Promise(function(resolve, reject) {
    var s = document.createElement('script');
    s.src = src;
    s.crossOrigin = 'anonymous';
    s.onload = resolve;
    s.onerror = reject;
    document.head.appendChild(s);
  });
}

async function boot() {
  console.log('[FC] 1. React ë¡œë”© ì‹œì‘...');
  await loadScript('https://unpkg.com/react@18/umd/react.production.min.js');
  console.log('[FC] 2. React ë¡œë”© ì™„ë£Œ, ReactDOM ë¡œë”© ì‹œì‘...');
  await loadScript('https://unpkg.com/react-dom@18/umd/react-dom.production.min.js');
  console.log('[FC] 3. ReactDOM ë¡œë”© ì™„ë£Œ, Babel ë¡œë”© ì‹œì‘...');
  await loadScript('https://unpkg.com/@babel/standalone/babel.min.js');
  console.log('[FC] 4. Babel ë¡œë”© ì™„ë£Œ, JSX ë³€í™˜ ì‹œì‘...');
  
  var code = document.getElementById('app-code').textContent;
  console.log('[FC] 5. ì½”ë“œ ê¸¸ì´: ' + code.length + 'ì');
  var transformed = Babel.transform(code, { presets: ['react'] }).code;
  console.log('[FC] 6. JSX ë³€í™˜ ì™„ë£Œ, ì‹¤í–‰ ì‹œì‘...');
  var script = document.createElement('script');
  script.textContent = transformed;
  document.body.appendChild(script);
  console.log('[FC] 7. ì•± ì‹¤í–‰ ì™„ë£Œ!');
}

boot().catch(function(err) { 
  console.error('[FC] ë¶€íŒ… ì‹¤íŒ¨:', err);
  document.getElementById('root').innerHTML = '<p style="color:red;padding:20px">Load error: ' + err.message + '</p>'; 
});
</script>
<script id="app-code" type="text/plain">
const{useState,useRef,useCallback,useEffect}=React;

const FONTS=[
  {name:"Noto Sans KR",label:"Noto Sans KR"},{name:"Nanum Gothic",label:"ë‚˜ëˆ”ê³ ë”•"},{name:"Nanum Myeongjo",label:"ë‚˜ëˆ”ëª…ì¡°"},
  {name:"Black Han Sans",label:"ë¸”ë™í•œì‚°ìŠ¤"},{name:"Do Hyeon",label:"ë„í˜„"},{name:"Jua",label:"ì£¼ì•„"},
  {name:"Arial",label:"Arial"},{name:"Georgia",label:"Georgia"},{name:"Times New Roman",label:"Times New Roman"},
  {name:"Courier New",label:"Courier New"},{name:"Verdana",label:"Verdana"},
];
const FONT_SIZES=[10,11,12,13,14,16,18,20,24,28,32,36,48];
const TEXT_COLORS=["#FFFFFF","#E2E8F0","#94A3B8","#64748B","#000000","#1E293B","#EF4444","#F97316","#EAB308","#22C55E","#3B82F6","#8B5CF6","#EC4899","#14B8A6","#F43F5E","#A855F7"];
const BLOCK_TYPES=[
  {type:"terminal",label:"ì‹œì‘/ë",desc:"ì‹œì‘ ë˜ëŠ” ë",color:"#4A90D9",gradient:["#5B9FE6","#3A7CC6"]},
  {type:"io",label:"ì…ë ¥/ì¶œë ¥",desc:"ë°ì´í„° ì…ì¶œë ¥",color:"#9B6DD7",gradient:["#AB7FE3","#8A5BC8"]},
  {type:"decision",label:"ê²°ì •",desc:"ì¡°ê±´ ë¶„ê¸°",color:"#E8A838",gradient:["#F0B84A","#D4922A"]},
  {type:"process",label:"í”„ë¡œì„¸ìŠ¤",desc:"ì²˜ë¦¬/ì‹¤í–‰",color:"#50B86C",gradient:["#5CC97A","#3EA85A"]},
];
const LINE_COLORS=[{label:"ê¸°ë³¸",value:null},{label:"ë¹¨ê°•",value:"#EF4444"},{label:"íŒŒë‘",value:"#3B82F6"},{label:"ì´ˆë¡",value:"#22C55E"},{label:"ë³´ë¼",value:"#A855F7"},{label:"ì£¼í™©",value:"#F97316"},{label:"ë¶„í™",value:"#EC4899"},{label:"ë…¸ë‘",value:"#EAB308"}];
const SNAP_DIST=28;
const DEFAULT_STYLE={fontFamily:"Noto Sans KR",fontSize:13,fontWeight:"normal",fontStyle:"normal",textDecoration:"none",fill:"#FFFFFF",textAlign:"center"};
const MIN_ZOOM=0.15,MAX_ZOOM=4;

function getId(){return"b"+Date.now()+Math.random().toString(36).slice(2,7)}
function getBlockAnchors(block){
  const{x,y,w,h,type}=block;
  if(type==="decision") return[{id:"top",cx:x+w/2,cy:y,role:"ì…ë ¥",side:"top"},{id:"right",cx:x+w,cy:y+h/2,role:"ë„¤ (Yes)",side:"right"},{id:"bottom",cx:x+w/2,cy:y+h,role:"ì•„ë‹ˆìš” (No)",side:"bottom"},{id:"left",cx:x,cy:y+h/2,role:"ì…ë ¥",side:"left"}];
  if(type==="terminal"){if((block.subType||"start")==="start")return[{id:"bottom",cx:x+w/2,cy:y+h,role:"ì¶œë°œì ",side:"bottom"}];return[{id:"top",cx:x+w/2,cy:y,role:"ë„ì°©ì ",side:"top"}]}
  return[{id:"top",cx:x+w/2,cy:y,role:"ì…ë ¥",side:"top"},{id:"right",cx:x+w,cy:y+h/2,role:"ì¶œë ¥",side:"right"},{id:"bottom",cx:x+w/2,cy:y+h,role:"ì¶œë ¥",side:"bottom"},{id:"left",cx:x,cy:y+h/2,role:"ì…ë ¥",side:"left"}];
}
function getAnchorPos(b,aid){const a=getBlockAnchors(b).find(an=>an.id===aid);return a?{x:a.cx,y:a.cy}:{x:b.x,y:b.y}}
function makeCurvePath(s,e,fS,tS){const d=Math.sqrt((e.x-s.x)**2+(e.y-s.y)**2),t=Math.min(Math.max(d*0.4,30),120),o={top:[0,-1],bottom:[0,1],left:[-1,0],right:[1,0]},f=o[fS]||[0,1],ts=o[tS]||[0,-1];return`M${s.x},${s.y} C${s.x+f[0]*t},${s.y+f[1]*t} ${e.x+ts[0]*t},${e.y+ts[1]*t} ${e.x},${e.y}`}

const _mc=document.createElement("canvas").getContext("2d");
function measureText(text,fontSize,fontFamily,fontWeight,fontStyle){_mc.font=`${fontStyle==="italic"?"italic ":""}${fontWeight==="bold"?"bold ":""}${fontSize}px '${fontFamily}','Noto Sans KR',sans-serif`;return _mc.measureText(text).width}

function BlockShape({type,x,y,w,h,selected,id}){
  const sel=selected?"#2563EB":"rgba(255,255,255,0.25)",sw=selected?2.5:1,ci=`clip-${id}`;
  if(type==="terminal"){const r=h/2;return(<g><defs><linearGradient id={`g-${id}`} x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stopColor="#5EA8F0"/><stop offset="100%" stopColor="#3B78C4"/></linearGradient><filter id={`f-${id}`} x="-8%" y="-8%" width="116%" height="125%"><feDropShadow dx="0" dy="3" stdDeviation="4" floodColor="#3B78C4" floodOpacity="0.25"/></filter><clipPath id={ci}><rect x={x} y={y} width={w} height={h} rx={r} ry={r}/></clipPath></defs><rect x={x} y={y} width={w} height={h} rx={r} ry={r} fill={`url(#g-${id})`} filter={`url(#f-${id})`} stroke={sel} strokeWidth={sw}/><ellipse cx={x+w/2} cy={y+h*.15} rx={w*.42} ry={h*.28} fill="rgba(255,255,255,0.15)" clipPath={`url(#${ci})`}/></g>)}
  if(type==="process"){return(<g><defs><linearGradient id={`g-${id}`} x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stopColor="#5FD47E"/><stop offset="100%" stopColor="#3AA85A"/></linearGradient><filter id={`f-${id}`} x="-8%" y="-8%" width="116%" height="125%"><feDropShadow dx="0" dy="3" stdDeviation="4" floodColor="#3AA85A" floodOpacity="0.25"/></filter><clipPath id={ci}><rect x={x} y={y} width={w} height={h} rx={6} ry={6}/></clipPath></defs><rect x={x} y={y} width={w} height={h} rx={6} ry={6} fill={`url(#g-${id})`} filter={`url(#f-${id})`} stroke={sel} strokeWidth={sw}/><ellipse cx={x+w/2} cy={y+h*.1} rx={w*.4} ry={h*.3} fill="rgba(255,255,255,0.12)" clipPath={`url(#${ci})`}/></g>)}
  if(type==="decision"){const cx=x+w/2,cy=y+h/2,pts=`${cx},${y} ${x+w},${cy} ${cx},${y+h} ${x},${cy}`;return(<g><defs><linearGradient id={`g-${id}`} x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stopColor="#F4C45A"/><stop offset="100%" stopColor="#D4922A"/></linearGradient><filter id={`f-${id}`} x="-10%" y="-8%" width="120%" height="125%"><feDropShadow dx="0" dy="3" stdDeviation="4" floodColor="#D4922A" floodOpacity="0.25"/></filter><clipPath id={ci}><polygon points={pts}/></clipPath></defs><polygon points={pts} fill={`url(#g-${id})`} filter={`url(#f-${id})`} stroke={sel} strokeWidth={sw}/><ellipse cx={cx} cy={y+h*.25} rx={w*.3} ry={h*.22} fill="rgba(255,255,255,0.12)" clipPath={`url(#${ci})`}/></g>)}
  if(type==="io"){const sk=Math.min(20,w*.11),pts=`${x+sk},${y} ${x+w},${y} ${x+w-sk},${y+h} ${x},${y+h}`;return(<g><defs><linearGradient id={`g-${id}`} x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stopColor="#B88AEA"/><stop offset="100%" stopColor="#8556C8"/></linearGradient><filter id={`f-${id}`} x="-8%" y="-8%" width="116%" height="125%"><feDropShadow dx="0" dy="3" stdDeviation="4" floodColor="#8556C8" floodOpacity="0.25"/></filter><clipPath id={ci}><polygon points={pts}/></clipPath></defs><polygon points={pts} fill={`url(#g-${id})`} filter={`url(#f-${id})`} stroke={sel} strokeWidth={sw}/><ellipse cx={x+w/2} cy={y+h*.15} rx={w*.38} ry={h*.28} fill="rgba(255,255,255,0.12)" clipPath={`url(#${ci})`}/></g>)}
  return null;
}

function ConnectionLine({conn,blocks,dark,onContextMenu}){
  const fb=blocks.find(b=>b.id===conn.from),tb=blocks.find(b=>b.id===conn.to);if(!fb||!tb)return null;
  const s=getAnchorPos(fb,conn.fromAnchor),e=getAnchorPos(tb,conn.toAnchor),path=makeCurvePath(s,e,conn.fromAnchor,conn.toAnchor);
  const label=conn.label||"",mx=(s.x+e.x)/2,my=(s.y+e.y)/2,dc=dark?"#94A3B8":"#505868",lc=conn.color||dc;
  return(<g onContextMenu={ev=>onContextMenu(ev,conn.id)}><defs><marker id={`arr-${conn.id}`} markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 1, 8 3.5, 0 6" fill={lc}/></marker></defs><path d={path} fill="none" stroke="transparent" strokeWidth={14} style={{cursor:"context-menu"}}/><path d={path} fill="none" stroke={lc} strokeWidth={2} markerEnd={`url(#arr-${conn.id})`}/>{label&&(<g><rect x={mx-22} y={my-13} width={44} height={22} rx={6} fill={dark?"#1E293B":"#1a1a2e"} opacity={.92} stroke={lc} strokeWidth={.5}/><text x={mx} y={my+2} textAnchor="middle" fontSize={11} fontFamily="'Noto Sans KR',sans-serif" fill="#fff" fontWeight="600">{label}</text></g>)}</g>);
}

function DotGrid({dark}){
  // Rendered as pattern for performance at any zoom
  const fill=dark?"rgba(100,116,139,0.22)":"rgba(170,178,190,0.3)";
  return(<defs><pattern id="dotgrid" width="24" height="24" patternUnits="userSpaceOnUse"><circle cx="0" cy="0" r="1" fill={fill}/></pattern></defs>);
}

function Toolbar({block,onStyleChange,dark}){
  const[showCP,setShowCP]=useState(false);
  const st=block?(block.style||DEFAULT_STYLE):DEFAULT_STYLE;
  const cls=dark?"toolbar-dark":"toolbar-light",disabled=!block,op=disabled?.35:1;
  const toggle=(p,on,off)=>{if(!block)return;onStyleChange({...st,[p]:st[p]===on?off:on})};
  const toggleDeco=d=>{if(!block)return;const cur=st.textDecoration||"none",parts=cur==="none"?[]:cur.split(" "),i=parts.indexOf(d);if(i>=0)parts.splice(i,1);else parts.push(d);onStyleChange({...st,textDecoration:parts.length?parts.join(" "):"none"})};
  const hasDeco=d=>(st.textDecoration||"none").includes(d);
  return(
    <div className={cls} style={{display:"flex",alignItems:"center",padding:"6px 12px",gap:4,flexWrap:"wrap",zIndex:50,flexShrink:0}}>
      <select className="tb-select" value={st.fontFamily} disabled={disabled} onChange={e=>{if(block)onStyleChange({...st,fontFamily:e.target.value})}} style={{width:140,opacity:op,fontFamily:`'${st.fontFamily}',sans-serif`}}>{FONTS.map(f=><option key={f.name} value={f.name} style={{fontFamily:`'${f.name}',sans-serif`}}>{f.label}</option>)}</select>
      <select className="tb-select" value={st.fontSize} disabled={disabled} onChange={e=>{if(block)onStyleChange({...st,fontSize:Number(e.target.value)})}} style={{width:56,opacity:op}}>{FONT_SIZES.map(s=><option key={s} value={s}>{s}</option>)}</select>
      <div className="tb-sep"/>
      <button className={`tb-btn ${st.fontWeight==="bold"?"active":""}`} disabled={disabled} style={{opacity:op,fontWeight:"bold"}} onClick={()=>toggle("fontWeight","bold","normal")}>B</button>
      <button className={`tb-btn ${st.fontStyle==="italic"?"active":""}`} disabled={disabled} style={{opacity:op,fontStyle:"italic",fontFamily:"Georgia"}} onClick={()=>toggle("fontStyle","italic","normal")}>I</button>
      <button className={`tb-btn ${hasDeco("underline")?"active":""}`} disabled={disabled} style={{opacity:op,textDecoration:"underline"}} onClick={()=>toggleDeco("underline")}>U</button>
      <button className={`tb-btn ${hasDeco("line-through")?"active":""}`} disabled={disabled} style={{opacity:op,textDecoration:"line-through"}} onClick={()=>toggleDeco("line-through")}>S</button>
      <div className="tb-sep"/>
      <div style={{position:"relative"}}><button className="tb-btn" disabled={disabled} style={{opacity:op,flexDirection:"column",gap:1}} onClick={e=>{e.stopPropagation();if(block)setShowCP(p=>!p)}}><span style={{fontSize:14,fontWeight:700}}>A</span><div style={{width:16,height:3,borderRadius:1,background:st.fill,marginTop:-2}}/></button>{showCP&&block&&(<div className={`color-popup ${dark?"color-popup-dark":"color-popup-light"}`} onClick={e=>e.stopPropagation()}>{TEXT_COLORS.map(c=>(<div key={c} className={`color-swatch ${st.fill===c?"active":""}`} style={{background:c}} onClick={()=>{onStyleChange({...st,fill:c});setShowCP(false)}}/>))}</div>)}</div>
      <div className="tb-sep"/>
      <button className={`tb-btn ${st.textAlign==="left"?"active":""}`} disabled={disabled} style={{opacity:op}} onClick={()=>{if(block)onStyleChange({...st,textAlign:"left"})}}><svg width="14" height="14" viewBox="0 0 14 14" fill="none"><line x1="1" y1="3" x2="13" y2="3" stroke="currentColor" strokeWidth="1.5"/><line x1="1" y1="7" x2="9" y2="7" stroke="currentColor" strokeWidth="1.5"/><line x1="1" y1="11" x2="11" y2="11" stroke="currentColor" strokeWidth="1.5"/></svg></button>
      <button className={`tb-btn ${st.textAlign==="center"?"active":""}`} disabled={disabled} style={{opacity:op}} onClick={()=>{if(block)onStyleChange({...st,textAlign:"center"})}}><svg width="14" height="14" viewBox="0 0 14 14" fill="none"><line x1="1" y1="3" x2="13" y2="3" stroke="currentColor" strokeWidth="1.5"/><line x1="3" y1="7" x2="11" y2="7" stroke="currentColor" strokeWidth="1.5"/><line x1="2" y1="11" x2="12" y2="11" stroke="currentColor" strokeWidth="1.5"/></svg></button>
      <button className={`tb-btn ${st.textAlign==="right"?"active":""}`} disabled={disabled} style={{opacity:op}} onClick={()=>{if(block)onStyleChange({...st,textAlign:"right"})}}><svg width="14" height="14" viewBox="0 0 14 14" fill="none"><line x1="1" y1="3" x2="13" y2="3" stroke="currentColor" strokeWidth="1.5"/><line x1="5" y1="7" x2="13" y2="7" stroke="currentColor" strokeWidth="1.5"/><line x1="3" y1="11" x2="13" y2="11" stroke="currentColor" strokeWidth="1.5"/></svg></button>
      {block&&<div style={{marginLeft:"auto",fontSize:11,opacity:.4,userSelect:"none"}}>{block.type==="terminal"?(block.subType==="start"?"ì‹œì‘":"ë"):block.type==="process"?"í”„ë¡œì„¸ìŠ¤":block.type==="decision"?"ê²°ì •":"ì…ë ¥/ì¶œë ¥"} ì„ íƒë¨</div>}
    </div>
  );
}

function BlockText({block}){
  const st=block.style||DEFAULT_STYLE,txt=block.text||(block.type==="terminal"?(block.subType==="start"?"ì‹œì‘":"ë"):"");
  if(!txt)return null;
  const lines=txt.split("\n"),lineH=st.fontSize*1.4,totalH=lines.length*lineH,baseY=block.y+(block.h-totalH)/2;
  let anchor="middle",dx=block.w/2;if(st.textAlign==="left"){anchor="start";dx=14}else if(st.textAlign==="right"){anchor="end";dx=block.w-14}
  return(<g pointerEvents="none">{lines.map((line,i)=>{
    const ly=baseY+i*lineH+st.fontSize*.85,tw=measureText(line,st.fontSize,st.fontFamily,st.fontWeight,st.fontStyle);
    let lx=block.x+dx;if(anchor==="middle")lx-=tw/2;else if(anchor==="end")lx-=tw;
    const deco=st.textDecoration||"none";
    return(<g key={i}><text x={block.x+dx} y={ly} textAnchor={anchor} fontSize={st.fontSize} fontFamily={`'${st.fontFamily}','Noto Sans KR',sans-serif`} fill={st.fill} fontWeight={st.fontWeight} fontStyle={st.fontStyle} style={{textShadow:"0 1px 3px rgba(0,0,0,0.4)"}}>{line}</text>
      {deco.includes("underline")&&<line x1={lx} y1={ly+3} x2={lx+tw} y2={ly+3} stroke={st.fill} strokeWidth={1} opacity={.85}/>}
      {deco.includes("line-through")&&<line x1={lx} y1={ly-st.fontSize*.3} x2={lx+tw} y2={ly-st.fontSize*.3} stroke={st.fill} strokeWidth={1} opacity={.85}/>}
    </g>);
  })}</g>);
}

function generateCleanSVG(blocks,connections){
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  blocks.forEach(b=>{minX=Math.min(minX,b.x-30);minY=Math.min(minY,b.y-30);maxX=Math.max(maxX,b.x+b.w+30);maxY=Math.max(maxY,b.y+b.h+30)});
  connections.forEach(c=>{const fb=blocks.find(b=>b.id===c.from),tb=blocks.find(b=>b.id===c.to);if(fb&&tb){const s=getAnchorPos(fb,c.fromAnchor),e=getAnchorPos(tb,c.toAnchor);minX=Math.min(minX,s.x-30,e.x-30);minY=Math.min(minY,s.y-30,e.y-30);maxX=Math.max(maxX,s.x+30,e.x+30);maxY=Math.max(maxY,s.y+30,e.y+30)}});
  const pad=40;minX-=pad;minY-=pad;maxX+=pad;maxY+=pad;const vw=maxX-minX,vh=maxY-minY;
  let svg=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="${minX} ${minY} ${vw} ${vh}" width="${vw}" height="${vh}">\n<rect x="${minX}" y="${minY}" width="${vw}" height="${vh}" fill="white"/>\n<defs><marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 1, 8 3.5, 0 6" fill="#333"/></marker></defs>\n`;
  connections.forEach(c=>{const fb=blocks.find(b=>b.id===c.from),tb=blocks.find(b=>b.id===c.to);if(!fb||!tb)return;const s=getAnchorPos(fb,c.fromAnchor),e=getAnchorPos(tb,c.toAnchor),path=makeCurvePath(s,e,c.fromAnchor,c.toAnchor);svg+=`<path d="${path}" fill="none" stroke="#333" stroke-width="1.5" marker-end="url(#arrow)"/>\n`;if(c.label){const mx=(s.x+e.x)/2,my=(s.y+e.y)/2;svg+=`<text x="${mx}" y="${my-6}" text-anchor="middle" font-size="11" font-family="'Noto Sans KR',sans-serif" fill="#333">${c.label}</text>\n`}});
  blocks.forEach(b=>{const{x,y,w,h,type}=b,st=b.style||DEFAULT_STYLE,txt=b.text||(type==="terminal"?(b.subType==="start"?"ì‹œì‘":"ë"):"");
    if(type==="terminal"){const r=h/2;svg+=`<rect x="${x}" y="${y}" width="${w}" height="${h}" rx="${r}" ry="${r}" fill="white" stroke="#333" stroke-width="1.5"/>\n`}
    else if(type==="process")svg+=`<rect x="${x}" y="${y}" width="${w}" height="${h}" rx="3" ry="3" fill="white" stroke="#333" stroke-width="1.5"/>\n`;
    else if(type==="decision"){const cx=x+w/2,cy=y+h/2;svg+=`<polygon points="${cx},${y} ${x+w},${cy} ${cx},${y+h} ${x},${cy}" fill="white" stroke="#333" stroke-width="1.5"/>\n`}
    else if(type==="io"){const sk=Math.min(20,w*.11);svg+=`<polygon points="${x+sk},${y} ${x+w},${y} ${x+w-sk},${y+h} ${x},${y+h}" fill="white" stroke="#333" stroke-width="1.5"/>\n`}
    if(txt){const lines=txt.split("\n"),lineH=st.fontSize*1.4,totalH=lines.length*lineH,baseYY=y+(h-totalH)/2;let anchor="middle",dxx=w/2;if(st.textAlign==="left"){anchor="start";dxx=14}else if(st.textAlign==="right"){anchor="end";dxx=w-14}
      lines.forEach((line,i)=>{const ly=baseYY+i*lineH+st.fontSize*.85;let da="";const deco=st.textDecoration||"none";if(deco!=="none")da=` text-decoration="${deco}"`;svg+=`<text x="${x+dxx}" y="${ly}" text-anchor="${anchor}" font-size="${st.fontSize}" font-family="'${st.fontFamily}','Noto Sans KR',sans-serif" font-weight="${st.fontWeight}" font-style="${st.fontStyle}" fill="#333"${da}>${line}</text>\n`})}});
  svg+=`</svg>`;return svg;
}

function App(){
  const[blocks,setBlocks]=useState([]);const[connections,setConnections]=useState([]);
  const[selected,setSelected]=useState(null);const[dragging,setDragging]=useState(null);
  const[connecting,setConnecting]=useState(null);const[tempLine,setTempLine]=useState(null);
  const[hoveredAnchor,setHoveredAnchor]=useState(null);const[editingBlock,setEditingBlock]=useState(null);
  const[editText,setEditText]=useState("");const[showSubTypeMenu,setShowSubTypeMenu]=useState(null);
  const[resizing,setResizing]=useState(null);const[nearestAnchor,setNearestAnchor]=useState(null);
  const[dark,setDark]=useState(true);const[colorPicker,setColorPicker]=useState(null);
  const[showExport,setShowExport]=useState(false);
  // Zoom state
  const[zoom,setZoom]=useState(1);
  const[pan,setPan]=useState({x:0,y:0});
  const[showZoom,setShowZoom]=useState(false);
  const zoomTimerRef=useRef(null);

  const svgRef=useRef(null);const scrollRef=useRef(null);const panelRef=useRef(null);
  const[dragOverPanel,setDragOverPanel]=useState(false);
  const CW=4000,CH=3000;

  const selectedBlock=blocks.find(b=>b.id===selected)||null;
  const handleStyleChange=ns=>{if(!selected)return;setBlocks(p=>p.map(b=>b.id===selected?{...b,style:ns}:b))};

  // Convert screen coords -> canvas coords accounting for zoom+pan+scroll
  const getCC=useCallback(e=>{
    const container=scrollRef.current;if(!container)return{x:0,y:0};
    const rect=container.getBoundingClientRect();
    const sx=container.scrollLeft,sy=container.scrollTop;
    const cx=e.clientX-rect.left,cy=e.clientY-rect.top;
    return{x:(cx+sx-pan.x)/zoom,y:(cy+sy-pan.y)/zoom};
  },[zoom,pan]);

  // Zoom handler
  const handleWheel=useCallback(e=>{
    if(!e.ctrlKey&&!e.metaKey)return; // only ctrl+wheel
    e.preventDefault();
    const container=scrollRef.current;if(!container)return;
    const rect=container.getBoundingClientRect();
    // mouse position relative to container
    const mx=e.clientX-rect.left+container.scrollLeft;
    const my=e.clientY-rect.top+container.scrollTop;
    // world coords under mouse before zoom
    const wx=(mx-pan.x)/zoom;
    const wy=(my-pan.y)/zoom;

    const delta=e.deltaY>0?0.9:1.1;
    const newZoom=Math.min(MAX_ZOOM,Math.max(MIN_ZOOM,zoom*delta));

    // adjust pan so world point under mouse stays put
    const newPanX=mx-wx*newZoom;
    const newPanY=my-wy*newZoom;

    setZoom(newZoom);
    setPan({x:newPanX,y:newPanY});

    // show zoom badge
    setShowZoom(true);
    if(zoomTimerRef.current)clearTimeout(zoomTimerRef.current);
    zoomTimerRef.current=setTimeout(()=>setShowZoom(false),1200);
  },[zoom,pan]);

  useEffect(()=>{
    const el=scrollRef.current;if(!el)return;
    el.addEventListener("wheel",handleWheel,{passive:false});
    return()=>el.removeEventListener("wheel",handleWheel);
  },[handleWheel]);

  const resetZoom=()=>{setZoom(1);setPan({x:0,y:0})};

  const handleDragFromPanel=useCallback((e,type)=>{console.log('[FC] íŒ¨ë„ì—ì„œ ë“œë˜ê·¸ ì‹œì‘:',type);e.dataTransfer.setData("blockType",type)},[]);
  const handleCanvasDrop=useCallback(e=>{
    e.preventDefault();const type=e.dataTransfer.getData("blockType");
    console.log('[FC] ìº”ë²„ìŠ¤ ë“œë¡­ ì´ë²¤íŠ¸, blockType:',type);
    if(!type){console.warn('[FC] blockType ë¹„ì–´ìˆìŒ!');return;}
    const{x:mx,y:my}=getCC(e);let w=160,h=60;if(type==="decision"){w=130;h=90}if(type==="io"){w=170;h=60}
    const nb={id:getId(),type,x:mx-w/2,y:my-h/2,w,h,text:type==="terminal"?"ì‹œì‘":"",subType:type==="terminal"?"start":undefined,style:{...DEFAULT_STYLE}};
    if(type==="terminal")setShowSubTypeMenu({block:nb,mx:e.clientX,my:e.clientY});
    else{console.log('[FC] ë¸”ë¡ ìƒì„±:',nb.id,type);setBlocks(p=>[...p,nb]);setSelected(nb.id)}
  },[getCC]);

  const handleSubTypeSelect=st=>{if(!showSubTypeMenu)return;const b={...showSubTypeMenu.block,subType:st,text:st==="start"?"ì‹œì‘":"ë"};setBlocks(p=>[...p,b]);setSelected(b.id);setShowSubTypeMenu(null)};
  const handleBlockMouseDown=(e,id)=>{if(e.button!==0)return;e.stopPropagation();setSelected(id);const b=blocks.find(bl=>bl.id===id);if(!b)return;const{x:mx,y:my}=getCC(e);setDragging({id,offsetX:mx-b.x,offsetY:my-b.y})};
  const handleAnchorMouseDown=(e,blockId,anchorId,anchor)=>{e.stopPropagation();setConnecting({fromBlock:blockId,fromAnchor:anchorId,fromSide:anchor.side});setTempLine({x1:anchor.cx,y1:anchor.cy,x2:anchor.cx,y2:anchor.cy,fromSide:anchor.side})};
  const handleResizeMouseDown=(e,blockId)=>{e.stopPropagation();const b=blocks.find(bl=>bl.id===blockId);if(!b)return;setResizing({id:blockId,startX:e.clientX,startY:e.clientY,origW:b.w,origH:b.h})};
  const findNearest=useCallback((mx,my,exId)=>{let best=null,bestD=SNAP_DIST/zoom;for(const b of blocks){if(b.id===exId)continue;for(const a of getBlockAnchors(b)){const d=Math.sqrt((a.cx-mx)**2+(a.cy-my)**2);if(d<bestD){bestD=d;best={blockId:b.id,anchorId:a.id,cx:a.cx,cy:a.cy,side:a.side}}}}return best},[blocks,zoom]);

  const handleMouseMove=useCallback(e=>{
    if(!svgRef.current)return;const{x:mx,y:my}=getCC(e);
    if(dragging){
      setBlocks(p=>p.map(b=>b.id===dragging.id?{...b,x:mx-dragging.offsetX,y:my-dragging.offsetY}:b));
      if(panelRef.current){const pr=panelRef.current.getBoundingClientRect();setDragOverPanel(e.clientX>=pr.left&&e.clientX<=pr.right&&e.clientY>=pr.top&&e.clientY<=pr.bottom)}
    }
    if(connecting){const near=findNearest(mx,my,connecting.fromBlock);setNearestAnchor(near);setTempLine(p=>p?{...p,x2:near?near.cx:mx,y2:near?near.cy:my,toSide:near?.side||null}:null)}
    if(resizing){const dx=(e.clientX-resizing.startX)/zoom,dy=(e.clientY-resizing.startY)/zoom;setBlocks(p=>p.map(b=>b.id!==resizing.id?b:{...b,w:Math.max(80,resizing.origW+dx),h:Math.max(40,resizing.origH+dy)}))}
  },[dragging,connecting,resizing,findNearest,getCC,zoom]);

  const handleMouseUp=useCallback(e=>{
    if(dragging&&panelRef.current){const pr=panelRef.current.getBoundingClientRect();if(e.clientX>=pr.left&&e.clientX<=pr.right&&e.clientY>=pr.top&&e.clientY<=pr.bottom){const did=dragging.id;setBlocks(p=>p.filter(b=>b.id!==did));setConnections(p=>p.filter(c=>c.from!==did&&c.to!==did));setSelected(null);setDragging(null);setResizing(null);setDragOverPanel(false);return}}
    if(connecting){const{x:mx,y:my}=getCC(e);const found=findNearest(mx,my,connecting.fromBlock);
      if(found){const fb=blocks.find(b=>b.id===connecting.fromBlock);let label="";if(fb?.type==="decision"){if(connecting.fromAnchor==="right")label="ë„¤";if(connecting.fromAnchor==="bottom")label="ì•„ë‹ˆìš”"}
        setConnections(p=>[...p,{id:getId(),from:connecting.fromBlock,fromAnchor:connecting.fromAnchor,to:found.blockId,toAnchor:found.anchorId,label,color:null}])}
      setConnecting(null);setTempLine(null);setNearestAnchor(null)}
    setDragging(null);setResizing(null);setDragOverPanel(false);
  },[connecting,blocks,findNearest,getCC]);

  useEffect(()=>{window.addEventListener("mousemove",handleMouseMove);window.addEventListener("mouseup",handleMouseUp);return()=>{window.removeEventListener("mousemove",handleMouseMove);window.removeEventListener("mouseup",handleMouseUp)}},[handleMouseMove,handleMouseUp]);

  const handleBlockDoubleClick=(e,id)=>{e.stopPropagation();const b=blocks.find(bl=>bl.id===id);if(!b||b.type==="terminal")return;setEditingBlock(id);setEditText(b.text||"")};
  const commitEdit=()=>{if(editingBlock)setBlocks(p=>p.map(b=>b.id===editingBlock?{...b,text:editText}:b));setEditingBlock(null);setEditText("")};
  const deleteSelected=useCallback(()=>{if(!selected||editingBlock)return;setBlocks(p=>p.filter(b=>b.id!==selected));setConnections(p=>p.filter(c=>c.from!==selected&&c.to!==selected));setSelected(null)},[selected,editingBlock]);

  useEffect(()=>{const h=e=>{if((e.key==="Delete"||e.key==="Backspace")&&!editingBlock)deleteSelected();if(e.key==="Escape"){setSelected(null);setShowSubTypeMenu(null);setColorPicker(null);setShowExport(false);if(editingBlock)commitEdit()}};window.addEventListener("keydown",h);return()=>window.removeEventListener("keydown",h)},[selected,editingBlock,editText,deleteSelected]);
  useEffect(()=>{if(!colorPicker)return;const h=()=>setColorPicker(null);window.addEventListener("click",h);return()=>window.removeEventListener("click",h)},[colorPicker]);

  const handleConnRightClick=(e,connId)=>{e.preventDefault();e.stopPropagation();setColorPicker({connId,x:e.clientX,y:e.clientY})};
  const setConnColor=(connId,color)=>{setConnections(p=>p.map(c=>c.id===connId?{...c,color}:c));setColorPicker(null)};

  const downloadPNG=useCallback(()=>{
    const svg=svgRef.current;if(!svg||blocks.length===0)return;
    let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
    blocks.forEach(b=>{minX=Math.min(minX,b.x-20);minY=Math.min(minY,b.y-20);maxX=Math.max(maxX,b.x+b.w+20);maxY=Math.max(maxY,b.y+b.h+20)});
    connections.forEach(c=>{const fb=blocks.find(b=>b.id===c.from),tb=blocks.find(b=>b.id===c.to);if(fb&&tb){const s=getAnchorPos(fb,c.fromAnchor),e=getAnchorPos(tb,c.toAnchor);minX=Math.min(minX,s.x-20,e.x-20);minY=Math.min(minY,s.y-20,e.y-20);maxX=Math.max(maxX,s.x+20,e.x+20);maxY=Math.max(maxY,s.y+20,e.y+20)}});
    const pad=40;minX-=pad;minY-=pad;maxX+=pad;maxY+=pad;const vw=maxX-minX,vh=maxY-minY,scale=2;
    const clone=svg.cloneNode(true);clone.setAttribute("width",vw);clone.setAttribute("height",vh);clone.setAttribute("viewBox",`${minX} ${minY} ${vw} ${vh}`);
    const bgR=document.createElementNS("http://www.w3.org/2000/svg","rect");bgR.setAttribute("x",minX);bgR.setAttribute("y",minY);bgR.setAttribute("width",vw);bgR.setAttribute("height",vh);bgR.setAttribute("fill",dark?"#0F172A":"#F3F4F6");clone.insertBefore(bgR,clone.firstChild);
    const data=new XMLSerializer().serializeToString(clone);const blob=new Blob([data],{type:"image/svg+xml;charset=utf-8"});const url=URL.createObjectURL(blob);
    const img=new Image();img.onload=()=>{const canvas=document.createElement("canvas");canvas.width=vw*scale;canvas.height=vh*scale;const ctx=canvas.getContext("2d");ctx.scale(scale,scale);ctx.drawImage(img,0,0);URL.revokeObjectURL(url);const a=document.createElement("a");a.download="flowchart.png";a.href=canvas.toDataURL("image/png");a.click()};img.src=url;
  },[blocks,connections,dark]);

  const downloadCleanSVG=useCallback(()=>{if(blocks.length===0)return;const svgStr=generateCleanSVG(blocks,connections);const blob=new Blob([svgStr],{type:"image/svg+xml;charset=utf-8"});const a=document.createElement("a");a.download="flowchart-clean.svg";a.href=URL.createObjectURL(blob);a.click();setShowExport(false)},[blocks,connections]);

  const bg=dark?"#0F172A":"#F3F4F6",panelBg=dark?"#1E293B":"#12131A";

  const renderPalette=bt=>{
    const w=68,h=38,gId=`pal-${bt.type}`;
    const grad=<defs><linearGradient id={gId} x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stopColor={bt.gradient[0]}/><stop offset="100%" stopColor={bt.gradient[1]}/></linearGradient></defs>;
    let shape;
    if(bt.type==="terminal")shape=<g>{grad}<rect x={6} y={6} width={w} height={h} rx={h/2} ry={h/2} fill={`url(#${gId})`} stroke="rgba(255,255,255,0.3)" strokeWidth={1}/></g>;
    else if(bt.type==="process")shape=<g>{grad}<rect x={6} y={6} width={w} height={h} rx={5} ry={5} fill={`url(#${gId})`} stroke="rgba(255,255,255,0.3)" strokeWidth={1}/></g>;
    else if(bt.type==="decision"){const cx=6+w/2,cy=6+h/2;shape=<g>{grad}<polygon points={`${cx},6 ${6+w},${cy} ${cx},${6+h} 6,${cy}`} fill={`url(#${gId})`} stroke="rgba(255,255,255,0.3)" strokeWidth={1}/></g>}
    else{const sk=9;shape=<g>{grad}<polygon points={`${6+sk},6 ${6+w},6 ${6+w-sk},${6+h} 6,${6+h}`} fill={`url(#${gId})`} stroke="rgba(255,255,255,0.3)" strokeWidth={1}/></g>}
    return(<div key={bt.type} draggable="true" onDragStart={e=>handleDragFromPanel(e,bt.type)} style={{cursor:"grab",padding:"10px 8px",background:"rgba(255,255,255,0.04)",borderRadius:10,border:"1px solid rgba(255,255,255,0.08)",display:"flex",flexDirection:"column",alignItems:"center",gap:6,transition:"all 0.2s",userSelect:"none"}} onMouseEnter={e=>{e.currentTarget.style.background="rgba(255,255,255,0.1)";e.currentTarget.style.borderColor=bt.color+"66"}} onMouseLeave={e=>{e.currentTarget.style.background="rgba(255,255,255,0.04)";e.currentTarget.style.borderColor="rgba(255,255,255,0.08)"}}><svg width={80} height={50} viewBox="0 0 80 50">{shape}</svg><span style={{fontSize:12,color:"#E0E0E0",fontWeight:600}}>{bt.label}</span><span style={{fontSize:10,color:"#777"}}>{bt.desc}</span></div>);
  };

  const renderTemp=()=>{
    if(!tempLine)return null;const s={x:tempLine.x1,y:tempLine.y1},en={x:tempLine.x2,y:tempLine.y2};
    const fS=tempLine.fromSide||"bottom",tS=tempLine.toSide||(Math.abs(en.y-s.y)>Math.abs(en.x-s.x)?"top":"left");
    const path=makeCurvePath(s,en,fS,tS);const snapped=!!nearestAnchor,col=snapped?"#2563EB":(dark?"#64748B":"#94A3B8");
    return(<g><defs><marker id="tmp-arr" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 1, 8 3.5, 0 6" fill={col}/></marker></defs><path d={path} fill="none" stroke={col} strokeWidth={snapped?2.5:2} markerEnd="url(#tmp-arr)" style={{filter:snapped?"drop-shadow(0 0 8px rgba(37,99,235,0.5))":"none"}}/>{snapped&&nearestAnchor&&(<circle cx={nearestAnchor.cx} cy={nearestAnchor.cy} r={12} fill="none" stroke="#2563EB" strokeWidth={2} opacity={.5}><animate attributeName="r" from="10" to="20" dur=".8s" repeatCount="indefinite"/><animate attributeName="opacity" from=".6" to="0" dur=".8s" repeatCount="indefinite"/></circle>)}</g>);
  };

  // SVG viewBox based on zoom/pan
  const svgW=CW*zoom,svgH=CH*zoom;

  return(
    <div style={{display:"flex",flexDirection:"column",width:"100vw",height:"100vh",overflow:"hidden",fontFamily:"'Noto Sans KR',sans-serif",background:bg,transition:"background 0.3s"}}>
      <Toolbar block={selectedBlock} onStyleChange={handleStyleChange} dark={dark}/>
      <div style={{display:"flex",flex:1,overflow:"hidden"}}>
        {/* Canvas */}
        <div ref={scrollRef} className={dark?"dark-scroll":"light-scroll"} style={{flex:1,position:"relative",overflow:"auto"}}
          onDragOver={e=>e.preventDefault()} onDrop={handleCanvasDrop}
          onClick={()=>{setSelected(null);setShowSubTypeMenu(null);setColorPicker(null);setShowExport(false)}}>

          <svg ref={svgRef} width={svgW} height={svgH} viewBox={`0 0 ${CW} ${CH}`}
            style={{display:"block",cursor:dragging?"grabbing":resizing?"nwse-resize":"default",transformOrigin:"0 0"}}>
            <DotGrid dark={dark}/>
            <rect x="0" y="0" width={CW} height={CH} fill="url(#dotgrid)"/>
            {connections.map(c=><ConnectionLine key={c.id} conn={c} blocks={blocks} dark={dark} onContextMenu={handleConnRightClick}/>)}
            {renderTemp()}
            {connecting&&nearestAnchor&&<circle cx={nearestAnchor.cx} cy={nearestAnchor.cy} r={8} fill="rgba(37,99,235,0.15)" stroke="#2563EB" strokeWidth={2}/>}
            {blocks.map(block=>{
              const anchors=getBlockAnchors(block);const isSel=selected===block.id;const bStyle=block.style||DEFAULT_STYLE;
              return(<g key={block.id}>
                <BlockShape {...block} selected={isSel} id={block.id}/>
                {editingBlock===block.id?(
                  <foreignObject x={block.x+8} y={block.y+8} width={block.w-16} height={block.h-16}>
                    <textarea autoFocus value={editText} onChange={e=>setEditText(e.target.value)} onBlur={commitEdit} onKeyDown={e=>{if(e.key==="Escape")commitEdit()}}
                      style={{width:"100%",height:"100%",border:"none",background:"rgba(255,255,255,0.9)",outline:"none",textAlign:bStyle.textAlign||"center",fontSize:bStyle.fontSize,fontFamily:`'${bStyle.fontFamily}','Noto Sans KR',sans-serif`,fontWeight:bStyle.fontWeight,fontStyle:bStyle.fontStyle,borderRadius:4,color:"#1a1a2e",resize:"none",padding:"4px 6px",lineHeight:1.4}}/>
                  </foreignObject>
                ):(<BlockText block={block}/>)}
                <rect x={block.x} y={block.y} width={block.w} height={block.h} fill="transparent" stroke="none" style={{cursor:"move"}}
                  onMouseDown={e=>handleBlockMouseDown(e,block.id)} onDoubleClick={e=>handleBlockDoubleClick(e,block.id)} onClick={e=>{e.stopPropagation();setSelected(block.id)}}/>
                {(isSel||connecting)&&anchors.map(a=>{const hov=hoveredAnchor?.blockId===block.id&&hoveredAnchor?.anchorId===a.id;return(<g key={a.id} onMouseEnter={()=>setHoveredAnchor({blockId:block.id,anchorId:a.id,role:a.role})} onMouseLeave={()=>setHoveredAnchor(null)} onMouseDown={e=>handleAnchorMouseDown(e,block.id,a.id,a)} style={{cursor:"crosshair"}}><circle cx={a.cx} cy={a.cy} r={hov?8:5.5} fill={hov?"#2563EB":(dark?"#1E293B":"white")} stroke="#2563EB" strokeWidth={2} style={{filter:hov?"drop-shadow(0 0 6px rgba(37,99,235,0.6))":"none"}}/>{hov&&(<g><rect x={a.cx-42} y={a.cy-32} width={84} height={24} rx={7} fill="#0F172A" opacity={.94}/><text x={a.cx} y={a.cy-17} textAnchor="middle" fontSize={11} fill="#fff" fontWeight="500" fontFamily="'Noto Sans KR',sans-serif">{a.role}</text></g>)}</g>)})}
                {isSel&&!connecting&&(<g onMouseDown={e=>handleResizeMouseDown(e,block.id)} style={{cursor:"nwse-resize"}}><rect x={block.x+block.w-6} y={block.y+block.h-6} width={12} height={12} rx={3} fill={dark?"#334155":"white"} stroke="#2563EB" strokeWidth={1.5}/><line x1={block.x+block.w} y1={block.y+block.h+4} x2={block.x+block.w+4} y2={block.y+block.h} stroke="#2563EB" strokeWidth={1} opacity={.5}/><line x1={block.x+block.w+2} y1={block.y+block.h+4} x2={block.x+block.w+4} y2={block.y+block.h+2} stroke="#2563EB" strokeWidth={1} opacity={.5}/></g>)}
              </g>);
            })}
          </svg>

          {blocks.length===0&&(<div style={{position:"absolute",top:"50%",left:"calc(50% - 100px)",transform:"translate(-50%,-50%)",textAlign:"center",pointerEvents:"none",userSelect:"none"}}><div style={{fontSize:48,marginBottom:12,opacity:.2}}>ğŸ“</div><div style={{fontSize:16,fontWeight:600,color:dark?"#475569":"#888"}}>ìš°ì¸¡ íŒ¨ë„ì—ì„œ ë¸”ë¡ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</div></div>)}

          {/* Zoom indicator */}
          <div className="zoom-badge" style={{background:dark?"rgba(30,41,59,0.9)":"rgba(255,255,255,0.9)",color:dark?"#94A3B8":"#64748B",border:`1px solid ${dark?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"}`,opacity:showZoom?1:0,pointerEvents:showZoom?"auto":"none",cursor:showZoom?"pointer":"default"}}
            onClick={e=>{e.stopPropagation();resetZoom()}}>
            ğŸ” {Math.round(zoom*100)}%
          </div>

          {showSubTypeMenu&&(<div style={{position:"fixed",left:showSubTypeMenu.mx-70,top:showSubTypeMenu.my-24,background:"#1E293B",borderRadius:14,padding:"10px 6px",boxShadow:"0 12px 40px rgba(0,0,0,0.5)",zIndex:999,display:"flex",gap:6,border:"1px solid rgba(255,255,255,0.1)"}} onClick={e=>e.stopPropagation()}><button onClick={()=>handleSubTypeSelect("start")} style={{padding:"10px 22px",border:"none",borderRadius:10,background:"linear-gradient(135deg,#5EA8F0,#3B78C4)",color:"#fff",cursor:"pointer",fontSize:13,fontWeight:700}}>ì‹œì‘</button><button onClick={()=>handleSubTypeSelect("end")} style={{padding:"10px 22px",border:"none",borderRadius:10,background:"linear-gradient(135deg,#F06060,#C44040)",color:"#fff",cursor:"pointer",fontSize:13,fontWeight:700}}>ë</button></div>)}
          {colorPicker&&(<div onClick={e=>e.stopPropagation()} style={{position:"fixed",left:colorPicker.x,top:colorPicker.y,background:dark?"#1E293B":"#fff",borderRadius:12,padding:"10px 12px",boxShadow:"0 8px 32px rgba(0,0,0,0.4)",zIndex:999,border:`1px solid ${dark?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"}`,display:"flex",flexDirection:"column",gap:6}}><div style={{fontSize:11,fontWeight:700,color:dark?"#94A3B8":"#666",marginBottom:2}}>ì„  ìƒ‰ìƒ</div><div style={{display:"flex",gap:5,flexWrap:"wrap",maxWidth:160}}>{LINE_COLORS.map(lc=>{const conn=connections.find(c=>c.id===colorPicker.connId);const isActive=conn?.color===lc.value;const dc=lc.value||(dark?"#94A3B8":"#505868");return(<div key={lc.label} onClick={()=>setConnColor(colorPicker.connId,lc.value)} title={lc.label} style={{width:26,height:26,borderRadius:8,background:dc,cursor:"pointer",border:isActive?"2px solid #fff":"2px solid transparent"}}/>)})}</div></div>)}
        </div>

        {/* Panel */}
        <div ref={panelRef} style={{width:200,background:panelBg,borderLeft:"1px solid rgba(255,255,255,0.06)",display:"flex",flexDirection:"column",padding:"16px 12px",gap:10,overflowY:"auto",boxShadow:"-6px 0 30px rgba(0,0,0,0.2)",transition:"background 0.3s,border-color 0.2s",borderColor:dragOverPanel?"#EF4444":"transparent",position:"relative"}}>
          {dragOverPanel&&(<div style={{position:"absolute",inset:0,background:"rgba(239,68,68,0.08)",borderRadius:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",zIndex:10,pointerEvents:"none",gap:8}}><div style={{fontSize:36}}>ğŸ—‘ï¸</div><div style={{fontSize:13,fontWeight:700,color:"#EF4444"}}>ë†“ìœ¼ë©´ ì‚­ì œ</div></div>)}
          <div style={{fontSize:13,fontWeight:700,color:"#fff",letterSpacing:1.5,textTransform:"uppercase",padding:"10px 4px 12px",borderBottom:"1px solid rgba(255,255,255,0.08)",marginBottom:4}}>â¬¡ ë¸”ë¡ íŒ¨ë„</div>
          {BLOCK_TYPES.map(renderPalette)}
          <div style={{padding:"12px 0 4px",borderTop:"1px solid rgba(255,255,255,0.06)",marginTop:8}}>
            <div style={{fontSize:11,color:"#555",lineHeight:1.7}}>â€¢ ë¸”ë¡ì„ ìº”ë²„ìŠ¤ì— ë“œë˜ê·¸<br/>â€¢ ë”ë¸”í´ë¦­ìœ¼ë¡œ í…ìŠ¤íŠ¸ í¸ì§‘<br/>â€¢ <span style={{color:"#777"}}>Ctrl+íœ </span>ë¡œ ìº”ë²„ìŠ¤ í™•ëŒ€/ì¶•ì†Œ<br/>â€¢ <span style={{color:"#777"}}>ìš°í´ë¦­</span>ìœ¼ë¡œ ì„  ìƒ‰ìƒ ë³€ê²½</div>
          </div>
          <div style={{position:"relative"}}>
            <button onClick={e=>{e.stopPropagation();setShowExport(p=>!p)}} style={{width:"100%",padding:"10px 0",border:"none",borderRadius:10,cursor:"pointer",fontSize:12,fontWeight:700,fontFamily:"'Noto Sans KR',sans-serif",background:blocks.length>0?"linear-gradient(135deg,#3B82F6,#2563EB)":"rgba(255,255,255,0.06)",color:blocks.length>0?"#fff":"#555",boxShadow:blocks.length>0?"0 2px 10px rgba(37,99,235,0.3)":"none",display:"flex",alignItems:"center",justifyContent:"center",gap:6}}>ğŸ“¥ ë‚´ë³´ë‚´ê¸° â–¾</button>
            {showExport&&blocks.length>0&&(<div className={`export-menu ${dark?"export-menu-dark":"export-menu-light"}`} onClick={e=>e.stopPropagation()}>
              <button className="export-item" style={{color:dark?"#E2E8F0":"#334155"}} onMouseEnter={e=>e.currentTarget.style.background=dark?"rgba(255,255,255,0.06)":"rgba(0,0,0,0.04)"} onMouseLeave={e=>e.currentTarget.style.background="transparent"} onClick={()=>{downloadPNG();setShowExport(false)}}><span>ğŸ–¼ï¸</span><div><div style={{fontWeight:600}}>PNG ì´ë¯¸ì§€</div><div style={{fontSize:10,opacity:.5,marginTop:2}}>ìº”ë²„ìŠ¤ ê·¸ëŒ€ë¡œ ë˜ìŠ¤í„°</div></div></button>
              <button className="export-item" style={{color:dark?"#E2E8F0":"#334155"}} onMouseEnter={e=>e.currentTarget.style.background=dark?"rgba(255,255,255,0.06)":"rgba(0,0,0,0.04)"} onMouseLeave={e=>e.currentTarget.style.background="transparent"} onClick={downloadCleanSVG}><span>âœï¸</span><div><div style={{fontWeight:600}}>SVG ë²¡í„° (ì‹¬í”Œ)</div><div style={{fontSize:10,opacity:.5,marginTop:2}}>í° ë°°ê²½ ê¹”ë”í•œ ë„ë©´</div></div></button>
            </div>)}
          </div>
          <div style={{marginTop:"auto",padding:"14px 8px",borderTop:"1px solid rgba(255,255,255,0.06)",display:"flex",alignItems:"center",justifyContent:"space-between"}}>
            <span style={{fontSize:12,color:"#94A3B8",fontWeight:600}}>{dark?"ğŸŒ™ ë‹¤í¬":"â˜€ï¸ ë¼ì´íŠ¸"}</span>
            <div onClick={()=>setDark(d=>!d)} style={{width:44,height:24,borderRadius:12,cursor:"pointer",background:dark?"linear-gradient(135deg,#3B82F6,#2563EB)":"linear-gradient(135deg,#CBD5E1,#94A3B8)",position:"relative",transition:"background 0.3s"}}><div style={{width:18,height:18,borderRadius:9,background:"#fff",position:"absolute",top:3,left:dark?23:3,transition:"left .25s cubic-bezier(0.4,0,0.2,1)",boxShadow:"0 1px 4px rgba(0,0,0,0.2)"}}/></div>
          </div>
        </div>
      </div>
    </div>
  );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
